reset()

load("parameters.sage")

var('Z')

assume(Z, 'real')


# Physical Constants
charge = scipy.constants.e
m_i = scipy.constants.m_p
m_e = scipy.constants.m_e

# ----------------- Input of State ------------------------
#xs_before = (0.00012, 0.001875, 0.029875)
#xs = (0.000375, 0.002125, 0.030125)
#xs_after = (0.000625, 0.002375, 0.030375)

## t = 0
# At x ~ 0.000375
#0.000125	2.01680495764705e+17	128.610352896639	0.00698293689942563	5	0.000484899306610213	1.0471123776226e+16	63494375916830.1	2.34816687647552e-13	-2.58535204462479e+15	-0.0132302322402798	-2.33324312943575e+17	-1.0164047196364e+16
#0.000375	2.06720459398779e+17	131.134172022492	0.00773410116629739	5	0.000498847136863049	2.1401785495559e+16	62897002936309.3	2.36301146539323e-13	-5.21798299722876e+15	-0.0136158954605701	-4.80283628055728e+17	-9.78009305096398e+15
#0.000625	2.11758474181347e+17	133.566366410568	0.00814722481890238	5	0.000512424083021017	2.16394286573354e+16	62336526895246.1	2.37715442437611e-13	-5.21333111904506e+15	-0.0139917210419623	-4.93569537308104e+17	-7.39872856855156e+15

# At x ~ 0.002
#0.001875	2.36922484075824e+17	144.528295437868	0.00843138544070861	5	0.000575239827907091	2.2702199594277e+16	59979493295695	2.43903069122622e-13	-5.19538472296247e+15	-0.0157364176951189	-5.55229359700149e+17	-617495939059516
#0.002125	2.41950646999175e+17	146.510702343944	0.00838263447867927	5	0.00058687935683815	2.2893068013212e+16	59580319647723.9	2.4499124981498e-13	-5.19262734708696e+15	-0.0160608678550189	-5.66692523200999e+17	-383020038494464
#0.002375	2.46977436540022e+17	148.431609093135	0.0083261626458635	5	0.000598238332226783	2.30776583769374e+16	59200815915630.2	2.46037135950564e-13	-5.1900879387595e+15	-0.0163778813971028	-5.77891881612448e+17	-237040431490714

# At ~ 0.03
#0.029875	7.97497862496662e+17	230.604881563873	0.00407911055603217	5	0.00115261560925745	3.07540009156886e+16	2447431797.99549	2.84637313460239e-13	-265840974843.463	-0.0329168040165697	-1.15961596560103e+18	-3.79695044236915e-56
#0.030125	8.02497966665079e+17	230.925541420897	0.00406067487169197	5	0.00115501941384095	3.07833779750113e+16	1904760270.04525	2.84769121543239e-13	-207045485983.517	-0.0329983991921747	-1.16246528601999e+18	-3.23851246089802e-57
#0.030375	8.07498065750158e+17	231.243213884488	0.00404242168220412	5	0.001157402502895	3.08124781416336e+16	1482423102.14716	2.84899583290049e-13	-161253262984.932	-0.033079466377589	-1.16529586252069e+18	-2.71407726781042e-58

#density_s_before = (2.01680495764705e+17, 2.36922484075824e+17, 7.97497862496662e+17)
#density_s = (2.06720459398779e+17, 2.41950646999175e+17, 8.02497966665079e+17)
#density_s_after = (2.11758474181347e+17, 2.46977436540022e+17, 8.07498065750158e+17)
#temp_s_before = (128.610352896639, 144.528295437868, 230.604881563873)
#temp_s = (131.134172022492, 146.510702343944, 230.925541420897)
#temp_s_after = (133.566366410568, 148.431609093135, 231.243213884488)
#the_Z = (0.00773410116629739, 0.00838263447867927, 0.00406067487169197)


## t = 200
# At x ~ 0.000375 (Right at the edge)
#0.000125	4.19694805526202e+17	139.83874547183	1.29844765074621	2.01775641792249	0.000544386784229591	1.36984246522972e+17	61091846997238.9	2.40933372556314e-13	-3.21263226088532e+16	-0.0148533179687266	-1.0830727138855e+18	-1.13917195505192e+15
#0.000375	4.33724871698693e+17	143.5152651671	1.32882828495458	1.00180552546572	0.000565994806753792	1.94699539210822e+17	60304302344489.8	2.43026480934171e-13	-4.48788828332813e+16	-0.0154486726503973	-1.27065897812789e+18	-1.02590177988275e+15
#0.000625	4.5363600252481e+17	148.383345375858	1.35614614782532	1.12705397727891	0.000595028598736063	2.1747621184159e+17	59307074186648.7	2.45743174090385e-13	-4.90267542884953e+16	-0.016247234354056	-1.32319448882921e+18	-944594552169737

# At x ~ 0.002
#x	$n$	$T$	$Z$	$D$	$D_{an}$	$\Gamma_e^{an}$	$n_0$	$\langle\sigma_{cx} v\rangle$	$\Gamma_i^{cx}$	$D_{\pi\parallel}$	$\Gamma_i^{\pi\parallel}$	$\Gamma_i^{ol}$
#0.001875	5.25011171139421e+17	163.482319322465	1.45659916620318	1.95092542714814	0.000688141630100473	2.27690887456374e+17	56501480943441	2.53812246363164e-13	-4.81176944459356e+16	-0.0188249902028863	-1.19168187618349e+18	-557173039481322
#0.002125	5.35434214493223e+17	165.427742871548	1.47166341450206	2.13128525822014	0.000700479137552669	2.30504108694339e+17	56167794581565.9	2.5481649909684e-13	-4.83290085496657e+16	-0.0191697028228131	-1.17180463596314e+18	-466734643459656
#0.002375	5.45017799197483e+17	167.165974949308	1.48552149414179	2.31149230840068	0.000711564705839756	2.33494397297697e+17	55874584307141.2	2.55707178968072e-13	-4.86155187455718e+16	-0.0194804005875539	-1.15395821152485e+18	-377374818968410

# At x ~ 0.03
#0.029875	1.08143075661057e+18	221.574027780129	1.77718267908245	4.94713184277656	0.00108613644485018	6.09230942553967e+17	2496379657.78461	2.80904355987589e-13	-5407156833206.3	-0.0310182685391704	-1.37348458709749e+18	-1.55235354380374e-58
#0.030125	1.08615114035334e+18	221.843028685801	1.77821178953312	4.94743894562273	0.00108811581270749	6.12848344919829e+17	1943024953.06425	2.81018035060206e-13	-4232723648741.13	-0.0310869925862421	-1.37764340545142e+18	-1.15809327369854e-59
#0.030375	1.09087529545641e+18	222.110163544139	1.77923651112516	4.94775127669252	0.00109008262082869	6.16471134861609e+17	1512332115.80433	2.81130833603446e-13	-3313304089634.74	-0.0311554116345023	-1.38179703421831e+18	-8.48298023345065e-61

#density_s_before = (4.19694805526202e+17, 5.25011171139421e+17, 1.08143075661057e+18)
#density_s = (4.33724871698693e+17, 5.35434214493223e+17, 1.08615114035334e+18)
#density_s_after = (4.5363600252481e+17, 5.45017799197483e+17, 1.09087529545641e+18)
#temp_s_before = (139.83874547183, 163.482319322465, 221.574027780129)
#temp_s = (143.5152651671, 165.427742871548, 221.843028685801)
#temp_s_after = (148.383345375858, 167.165974949308, 222.110163544139)
#the_Z = (1.32882828495458, 1.47166341450206, 1.77821178953312)

## t = 800
# At x ~ 0.000375 (Right at the edge)
#0.000125	6.53978299041876e+17	135.540529186539	1.62800344121871	1.33044109663901	0.0004710606846596	2.25852569595119e+17	64110155007025.2	2.33310658187321e-13	-5.6485917708908e+16	-0.0128526524421729	-4.80671274330532e+17	-605143168304749
#0.000375	6.76246983345087e+17	139.122717899565	1.66528853536355	0.676277221221089	0.000489278121048814	2.97797470476393e+17	63304392822601.7	2.35286259135675e-13	-7.32339037934961e+16	-0.0133547118045778	-4.99487460333589e+17	-501247726198284
#0.000625	7.0992703546841e+17	144.107989430169	1.6980216752354	0.687658822488309	0.000512549787588051	3.27338637545564e+17	62331430397304.8	2.37728400049804e-13	-7.88532223365516e+16	-0.0139951534006158	-4.73871597547587e+17	-418015163021674

# At x ~ 0.002
#0.001875	8.30733006178698e+17	158.829442478889	1.87144476499267	3.12174123243608	0.000611115677940865	4.5157375542875e+17	58782037197675.7	2.47204309826438e-13	-1.00600681627474e+17	-0.0167178472379114	-3.99677340725589e+17	-207090017943546
#0.002125	8.3825021709018e+17	159.597412122243	1.91846049099646	4.39906205149668	0.000633087828050861	4.77826787928431e+17	58093978394304.2	2.49152383729744e-13	-1.04791173678783e+17	-0.0173254346544513	-4.15114565156592e+17	-192652479834509
#0.002375	8.4444700349267e+17	160.218708121321	1.96693718933301	4.88562856950413	0.00065455367041495	5.00300841898805e+17	57451849897798.9	2.51005427862661e-13	-1.08105878372374e+17	-0.0179196179927008	-4.33529105971265e+17	-177993978432309

# At x ~ 0.03
#0.029875	1.61043221055563e+18	210.074141567838	2.69927976059795	4.82669946915312	0.00100201284893243	1.275174663209e+18	2564371846.85397	2.75916854480241e-13	-11730517604838	-0.0286158371494225	-1.34684203204101e+17	-5.21060108467671e-62
#0.030125	1.61545847041041e+18	210.269807174714	2.70127620632695	4.82765751311035	0.00100341374358834	1.28117546250272e+18	1996227665.55463	2.76002531018542e-13	-9173134589521.49	-0.0286670915389496	-1.34827898125743e+17	-3.19866689589232e-63
#0.030375	1.62048565103957e+18	210.464545935855	2.7032650898528	4.82864733853262	0.00100480866327195	1.28718239401939e+18	1553957689.67112	2.76087749746738e-13	-7173173373156.79	-0.0287182154086203	-1.34974794461851e+17	-1.924564397156e-64

#density_s_before = (6.53978299041876e+17, 8.30733006178698e+17, 1.61043221055563e+18)
#density_s = (6.76246983345087e+17, 8.3825021709018e+17, 1.61545847041041e+18)
#density_s_after = (7.0992703546841e+17, 8.4444700349267e+17, 1.62048565103957e+18)
#temp_s_before = (135.540529186539, 158.829442478889, 210.074141567838)
#temp_s = (139.122717899565, 159.597412122243, 210.269807174714)
#temp_s_after = (144.107989430169, 160.218708121321, 210.464545935855)


# ---------------------------------------------------------
# VERY DIFFERENT SIMULATION!, t = 40000 * 0.5e-6
# At x ~ 0.000375 (Right at the edge)
#0.000125	1.66961184200284e+18	133.95528962092	5.38762939159226	0.526886025568035	3.18493678414841e+15	1.74746225019565e+18	62423585617004.6	2.37494372219926e-13	-4.21779499975342e+17	-0.0139228168935008	-20333059.3737417	-6436.3603405786
#0.000375	1.71542710436818e+18	136.841648205122	5.52034633528406	0.433380980298758	3.28842968351649e+15	1.98908320333337e+18	61761731496408.1	2.39188055371058e-13	-4.73323736777288e+17	-0.0143806221164862	-5289115.76438263	-1466.88309830249
#0.000625	1.76607593714944e+18	139.893892066433	5.64915046624966	0.435448659987283	3.39906490855809e+15	2.13916712267697e+18	61084238368447.6	2.40953378941912e-13	-5.01606301158364e+17	-0.0148700166004968	-1352581.65291988	-339.439374958758

# x ~ 0.025
#0.024875	4.83016479268114e+18	221.541846241295	10.5645175781961	0.923481315855607	6.76874920422432e+15	1.54770616773167e+19	367895062425.207	2.80808706272374e-13	-2.02470988684315e+16	-0.0307296410638399	-1.88763575496846e-28	-3.71370214216136e-54
#0.025125	4.84947260173874e+18	221.794048138173	10.5725839643187	1.1868747657649	6.77346528076106e+15	1.55716783156181e+19	286931370614.689	2.80852172588547e-13	-1.5886571356689e+16	-0.03076302720492	-1.02589984254347e-28	-4.65764542682023e-55
#0.025375	4.86354058652761e+18	221.968050867266	10.589744430826	2.04367063154886	6.7806955901798e+15	1.56826770361267e+19	223675382193.617	2.80918765965922e-13	-1.24710674007592e+16	-0.0308078626921528	-6.81545617349434e-29	-6.708306825538e-56

# x ~ 0.04
#0.039875	5.464978613989e+18	228.641348868427	11.3651853645684	3.22740558500598	7.1021894683553e+15	1.94406250995347e+19	111596.028050993	2.83825505494064e-13	-7673418204.56853	-0.0330145542138448	-8.10276713632313e-36	-2.84553335240271e-121
#0.040125	5.47243206765491e+18	228.714794108604	11.3729831576012	3.2671715858704	7.10561198074745e+15	1.94861225051002e+19	86897.1178799559	2.83855894067201e-13	-5988767572.42989	-0.0330436346948273	-6.80508528173182e-36	-1.05745020941501e-122
#0.040375	5.47980109123503e+18	228.787206086676	11.3805987488354	3.30717208119546	7.10898693401744e+15	1.95309893422369e+19	67664.8322502821	2.83885849215562e-13	-4673809376.61583	-0.0330725171216458	-5.73809360845573e-36	-3.83940416137105e-124

# DIFFERENT POSITIONS!
xs_before = (0.00012, 0.024875, 0.039875)
xs = (0.000375, 0.025125, 0.040125)
xs_after = (0.000625, 0.025375, 0.040375)

density_s_before = (1.66961184200284e+18, 4.83016479268114e+18, 5.464978613989e+18)
density_s = (1.71542710436818e+18, 4.84947260173874e+18, 5.47243206765491e+18)
density_s_after = (1.76607593714944e+18, 4.86354058652761e+18, 5.47980109123503e+18)
temp_s_before = (133.95528962092, 221.541846241295, 228.641348868427)
temp_s = (136.841648205122, 221.794048138173, 228.714794108604)
temp_s_after = (139.893892066433, 221.968050867266, 228.787206086676)
the_Z = (5.52034633528406, 10.5725839643187, 11.3729831576012)


# ---------------------------------------------------------
spot_choice = 2
x_before = xs_before[spot_choice]
x = xs[spot_choice]
x_after = xs_after[spot_choice]
density_before = density_s_before[spot_choice]
density = density_s[spot_choice]
density_after = density_s_after[spot_choice]
density_grad = (density_after - density_before) / (x_after - x_before)
temperature_before = temp_s_before[spot_choice]
temperature = temp_s[spot_choice]
temperature_after = temp_s_after[spot_choice]
temperature_grad = (temperature_after - temperature_before) / (x_after - x_before)

Gamma_c = -1.0e20



# ----------------- Values --------------------------------
# Thermal Velocity
v_Ti = sqrt(2.0 * charge * temperature / m_i)					# [m/s]
v_Te = sqrt(2.0 * charge * temperature / m_e)					# [m/s]

# Poloidal gyro-(Larmor) radii
rho_pi = m_i * v_Ti / (charge * B_theta)						# [m]
rho_pe = m_e * v_Te / (charge * B_theta)						# [m]

# Transition frequency
omega_t = v_Ti / (q*R)											# [s^-1]

# Banana orbit bounce frequencies
omega_bi = aspect**(3.0/2.0) * omega_t							# [s^-1]
omega_be = aspect**(3.0/2.0) * v_Te / (q * R)					# [s^-1]

# Banana width
w_bi = sqrt(aspect) * rho_pi									# [m]

# Collision frequencies within electrons and ions
nu_ei = 4.2058e-11*(density)\
		/ (temperature)**(3.0/2.0)								# [s^-1]
nu_ii = 1.2 * sqrt(m_e / m_i) * nu_ei							# [s^-1]


# Effective collision frequencies (Collisionalities)
nu_ai = nu_ii / omega_bi	# nu_*i
nu_ae = nu_ei / omega_be	# nu_*e (not used as of now)


## Electron Anomalous Diffusion
D_an = aspect**2 * sqrt(pi) * rho_pe * (temperature/charge) / (2*a_m * B)
g_n_an = charge * density * D_an								# [A m^-2]
g_T_an = g_n_an * alpha_an										# [A m^-2]
g_Z_an = g_n_an / rho_pi										# [A m^-1]

Gamma_an(Z) = g_n_an * density_grad / density  +  g_T_an * temperature_grad / temperature  +  g_Z_an * Z


## Charge Exchange Friction
n_0 = (-0.1*Gamma_c / v_Ti) / (1.0 + exp(1.0e3*(x-0.02)))		# [m^-3]
cx_rate = 1.0e-14 * (100*temperature)^(1.0 / 3.0)				# [m^3 s^-1]

g_n_cx = -(m_i * n_0 * cx_rate * density * temperature) / (B_theta^2) * ((B_theta^2 / (aspect * B_phi)^2) + 2.0)			# [A m^-2]
g_T_cx = alpha_cx * g_n_cx										# [A m^-2]
g_Z_cx = g_n_cx / rho_pi										# [A m^-1]

Gamma_cx(Z) = g_n_cx * density_grad / density  +  g_T_cx * temperature_grad / temperature  +  g_Z_an * Z


## Ion Bulk (Parallel) Viscosity
plasma_disp(Z) = imag(I*sqrt(pi) * e^(-(Z + I*nu_ii/omega_t)^2) * erfc(-I*(Z + I*nu_ii/omega_t)))
# Naive plasma dispersion:
#plasma_disp = sqrt(pi) * exp(-Z^2)
D_bulk = aspect^2 * rho_pi * temperature / ((x - a_m) * B * sqrt(pi))	# [m^2 s^-1]

Gamma_bulk(Z) = density * D_bulk * (density_grad / density  +  Z / rho_pi) * plasma_disp	# [m^-2 s^-1]


## Ion Orbit Loss
g_ol = -charge * density * nu_ii * nu_ai * rho_pi				# [A m^-2]
radical_ol = sqrt(nu_ai + (Z)^4 + ((x) / w_bi)^4)

Gamma_ol(Z) = g_ol * exp(-radical_ol) / (charge * radical_ol)	# [m^-2 s^-1]


## Sum of all the fluxes
#Gamma_sum = sage.plot.misc.setup_for_eval_on_grid(Gamma_an + Gamma_cx + Gamma_bulk + Gamma_ol, [(-7,7)], plot_points=10000)

# ----------------- Plotting ------------------------------
Zmin, Zmax = -3, 12.5
y_min, y_max = -4e19, 4.5e19
line_thickness = 2

plot_title = r"Im$\left[X(z)\right] \,=\, \sqrt{\pi} \, $Re$\left[\exp(-z^2) \,\right. $erfc$\left.(-i \, z)\right]$"
#plot_title = "$x = " + str((xs[spot_choice]*100).n(digits=5))+ "$ cm"

Gamma_an_plot = plot(Gamma_an, (Z, Zmin, Zmax), legend_label=r"$\Gamma_e^{an}$", color='red', gridlines=True, thickness=line_thickness, ymin=y_min, ymax=y_max)#, title=plot_title)
Gamma_cx_plot = plot(Gamma_cx, (Z, Zmin, Zmax), legend_label=r"$\Gamma_i^{cx}$", color='green', thickness=line_thickness, ymin=y_min, ymax=y_max)
Gamma_bulk_plot = plot(Gamma_bulk, (Z, Zmin, Zmax), legend_label=r"$\Gamma_i^{\pi\parallel}$", color='olive', thickness=line_thickness, ymin=y_min, ymax=y_max)
Gamma_ol_plot = plot(Gamma_ol, (Z, Zmin, Zmax), legend_label=r"$\Gamma_i^{ol}$", color='blue', thickness=line_thickness)

Gamma_sum_plot = plot(Gamma_an(Z) + Gamma_cx(Z) + Gamma_ol(Z) + Gamma_bulk(Z), (Z, Zmin, Zmax), legend_label=r"$\Sigma \Gamma^k$", color='magenta', gridlines=True, thickness=line_thickness, ymin=y_min, ymax=y_max, linestyle='--', axes_labels=["$Z$",""])#, title=plot_title)
#Gamma_sum_plot.show(figsize=[18,10], fontsize=24)

x_location = text("$x = " + str((xs[spot_choice]*100).n(digits=3))+ "$ cm\n $t = 20$ ms", (6,-2e19), color='black', fontsize=28)

combined_plot = Gamma_an_plot + Gamma_cx_plot + Gamma_ol_plot + Gamma_bulk_plot + Gamma_sum_plot + x_location + line([(the_Z[spot_choice], y_min - 0.1*y_min), (the_Z[spot_choice], y_max - 0.1*y_max)])
combined_plot.set_legend_options(font_size=28, loc='lower left')
combined_plot.show(figsize=[18,10], fontsize=24)

